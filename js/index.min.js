/*
 Copyright (c) 2013 Gildas Lormeau. All rights reserved.

 Redistribution and use in source and binary forms, with or without
 modification, are permitted provided that the following conditions are met:

 1. Redistributions of source code must retain the above copyright notice,
 this list of conditions and the following disclaimer.

 2. Redistributions in binary form must reproduce the above copyright
 notice, this list of conditions and the following disclaimer in
 the documentation and/or other materials provided with the distribution.

 3. The names of the authors may not be used to endorse or promote products
 derived from this software without specific prior written permission.

 THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED WARRANTIES,
 INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
 FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL JCRAFT,
 INC. OR ANY CONTRIBUTORS TO THIS SOFTWARE BE LIABLE FOR ANY DIRECT, INDIRECT,
 INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA,
 OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
 LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,
 EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

/*! JsRender v1.0pre: http://github.com/BorisMoore/jsrender */

/*
* Optimized version of jQuery Templates, for rendering to string.
* Does not require jQuery, or HTML DOM
* Integrates with JsViews (http://github.com/BorisMoore/jsviews)
* Copyright 2012, Boris Moore
* Released under the MIT License.
*/

function trigger(e,t){var n={type:t,target:e};for(var i in e.$listeners[n.type])e.$listeners[n.type][i](n)}if(function(e){function t(){var e=-1,t=this;t.append=function(n){var i,r=t.table;for(i=0;i<n.length;i++)e=e>>>8^r[255&(e^n[i])]},t.get=function(){return~e}}function n(e,t,n){return e.slice?e.slice(t,t+n):e.webkitSlice?e.webkitSlice(t,t+n):e.mozSlice?e.mozSlice(t,t+n):e.msSlice?e.msSlice(t,t+n):void 0}function i(e,t){var n,i;return n=new ArrayBuffer(e),i=new Uint8Array(n),t&&i.set(t,0),{buffer:n,array:i,view:new DataView(n)}}function r(){}function o(e){function t(t,n){var o=new Blob([e],{type:F});i=new s(o),i.init(function(){r.size=i.size,t()},n)}function n(e,t,n,r){i.readUint8Array(e,t,n,r)}var i,r=this;r.size=0,r.init=t,r.readUint8Array=n}function a(t){function n(e){for(var n=t.length;"="==t.charAt(n-1);)n--;o=t.indexOf(",")+1,a.size=Math.floor(.75*(n-o)),e()}function r(n,r,a){var s,l=i(r),c=4*Math.floor(n/3),u=4*Math.ceil((n+r)/3),d=e.atob(t.substring(c+o,u+o)),f=n-3*Math.floor(c/4);for(s=f;f+r>s;s++)l.array[s-f]=d.charCodeAt(s);a(l.array)}var o,a=this;a.size=0,a.init=n,a.readUint8Array=r}function s(e){function t(t){this.size=e.size,t()}function i(t,i,r,o){var a=new FileReader;a.onload=function(e){r(new Uint8Array(e.target.result))},a.onerror=o,a.readAsArrayBuffer(n(e,t,i))}var r=this;r.size=0,r.init=t,r.readUint8Array=i}function l(){}function c(e){function t(e){r=new Blob([],{type:F}),e()}function n(e,t){r=new Blob([r,$?e:e.buffer],{type:F}),t()}function i(t,n){var i=new FileReader;i.onload=function(e){t(e.target.result)},i.onerror=n,i.readAsText(r,e)}var r,o=this;o.init=t,o.writeUint8Array=n,o.getData=i}function u(t){function n(e){a+="data:"+(t||"")+";base64,",e()}function i(t,n){var i,r=s.length,o=s;for(s="",i=0;i<3*Math.floor((r+t.length)/3)-r;i++)o+=String.fromCharCode(t[i]);for(;i<t.length;i++)s+=String.fromCharCode(t[i]);o.length>2?a+=e.btoa(o):s=o,n()}function r(t){t(a+e.btoa(s))}var o=this,a="",s="";o.init=n,o.writeUint8Array=i,o.getData=r}function d(e){function t(t){r=new Blob([],{type:e}),t()}function n(t,n){r=new Blob([r,$?t:t.buffer],{type:e}),n()}function i(e){e(r)}var r,o=this;o.init=t,o.writeUint8Array=n,o.getData=i}function f(e,t,n,i,r,o,a,s,l,c){function u(){e.removeEventListener(N,d,!1),s(h)}function d(e){var t=e.data,i=t.data;t.onappend&&(h+=i.length,n.writeUint8Array(i,function(){o(!1,i),f()},c)),t.onflush&&(i?(h+=i.length,n.writeUint8Array(i,function(){o(!1,i),u()},c)):u()),t.progress&&a&&a(p+t.current,r)}function f(){p=v*j,r>p?t.readUint8Array(i+p,Math.min(j,r-p),function(t){e.postMessage({append:!0,data:t}),v++,a&&a(p,r),o(!0,t)},l):e.postMessage({flush:!0})}var p,h,v=0;h=0,e.addEventListener(N,d,!1),f()}function p(e,t,n,i,r,o,a,s,l,c){function u(){var h;d=f*j,r>d?t.readUint8Array(i+d,Math.min(j,r-d),function(t){var s=e.append(t,function(){a&&a(i+d,r)});p+=s.length,o(!0,t),n.writeUint8Array(s,function(){o(!1,s),f++,setTimeout(u,1)},c),a&&a(d,r)},l):(h=e.flush(),h?(p+=h.length,n.writeUint8Array(h,function(){o(!1,h),s(p)},c)):s(p))}var d,f=0,p=0;u()}function h(n,i,r,o,a,s,l,c,u){function d(e,t){a&&!e&&g.append(t)}function h(e){s(e,g.get())}var v,g=new t;return e.zip.useWebWorkers?(v=new Worker(e.zip.workerScriptsPath+M),f(v,n,i,r,o,d,l,h,c,u)):p(new e.zip.Inflater,n,i,r,o,d,l,h,c,u),v}function v(n,i,r,o,a,s,l){function c(e,t){e&&v.append(t)}function u(e){o(e,v.get())}function d(){h.removeEventListener(N,d,!1),f(h,n,i,0,n.size,c,a,u,s,l)}var h,v=new t;return e.zip.useWebWorkers?(h=new Worker(e.zip.workerScriptsPath+T),h.addEventListener(N,d,!1),h.postMessage({init:!0,level:r})):p(new e.zip.Deflater,n,i,0,n.size,c,a,u,s,l),h}function g(e,n,i,r,o,a,s,l,c){function u(){var t=d*j;r>t?e.readUint8Array(i+t,Math.min(j,r-t),function(e){o&&f.append(e),s&&s(t,r,e),n.writeUint8Array(e,function(){d++,u()},c)},l):a(r,f.get())}var d=0,f=new t;u()}function m(e){var t,n,i="",r=["Ç","ü","é","â","ä","à","å","ç","ê","ë","è","ï","î","ì","Ä","Å","É","æ","Æ","ô","ö","ò","û","ù","ÿ","Ö","Ü","ø","£","Ø","×","ƒ","á","í","ó","ú","ñ","Ñ","ª","º","¿","®","¬","½","¼","¡","«","»","_","_","_","¦","¦","Á","Â","À","©","¦","¦","+","+","¢","¥","+","+","-","-","+","-","+","ã","Ã","+","+","-","-","¦","-","+","¤","ð","Ð","Ê","Ë","È","i","Í","Î","Ï","+","+","_","_","¦","Ì","_","Ó","ß","Ô","Ò","õ","Õ","µ","þ","Þ","Ú","Û","Ù","ý","Ý","¯","´","­","±","_","¾","¶","§","÷","¸","°","¨","·","¹","³","²","_"," "];for(t=0;t<e.length;t++)n=255&e.charCodeAt(t),i+=n>127?r[n-128]:String.fromCharCode(n);return i}function y(e){return decodeURIComponent(escape(e))}function b(e){var t,n="";for(t=0;t<e.length;t++)n+=String.fromCharCode(e[t]);return n}function w(e){var t=(4294901760&e)>>16,n=65535&e;try{return new Date(1980+((65024&t)>>9),((480&t)>>5)-1,31&t,(63488&n)>>11,(2016&n)>>5,2*(31&n),0)}catch(i){}}function _(e,t,n,i,r){return e.version=t.view.getUint16(n,!0),e.bitFlag=t.view.getUint16(n+2,!0),e.compressionMethod=t.view.getUint16(n+4,!0),e.lastModDateRaw=t.view.getUint32(n+6,!0),e.lastModDate=w(e.lastModDateRaw),1===(1&e.bitFlag)?(r(A),void 0):((i||8!=(8&e.bitFlag))&&(e.crc32=t.view.getUint32(n+10,!0),e.compressedSize=t.view.getUint32(n+14,!0),e.uncompressedSize=t.view.getUint32(n+18,!0)),4294967295===e.compressedSize||4294967295===e.uncompressedSize?(r(q),void 0):(e.filenameLength=t.view.getUint16(n+22,!0),e.extraFieldLength=t.view.getUint16(n+24,!0),void 0))}function k(e,t){function n(){}function r(n,o){e.readUint8Array(e.size-n,n,function(e){var t=i(e.length,e).view;1347093766!=t.getUint32(0)?r(n+1,o):o(t)},function(){t(U)})}return n.prototype.getData=function(n,r,o,a){function s(e,t){f&&f.terminate(),f=null,e&&e(t)}function l(e){var t=i(4);return t.view.setUint32(0,e),p.crc32==t.view.getUint32(0)}function c(e,t){a&&!l(t)?u():n.getData(function(e){s(r,e)})}function u(){s(t,z)}function d(){s(t,D)}var f,p=this;e.readUint8Array(p.offset,30,function(r){var s,l=i(r.length,r);return 1347093252!=l.view.getUint32(0)?(t(x),void 0):(_(p,l,4,!1,t),s=p.offset+30+p.filenameLength+p.extraFieldLength,n.init(function(){0===p.compressionMethod?g(e,n,s,p.compressedSize,a,c,o,u,d):f=h(e,n,s,p.compressedSize,a,c,o,u,d)},d),void 0)},u)},{getEntries:function(o){return e.size<22?(t(x),void 0):(r(22,function(r){var a,s;a=r.getUint32(16,!0),s=r.getUint16(8,!0),e.readUint8Array(a,e.size-a,function(e){var r,a,l,c,u=0,d=[],f=i(e.length,e);for(r=0;s>r;r++){if(a=new n,1347092738!=f.view.getUint32(u))return t(x),void 0;_(a,f,u+6,!0,t),a.commentLength=f.view.getUint16(u+32,!0),a.directory=16==(16&f.view.getUint8(u+38)),a.offset=f.view.getUint32(u+42,!0),l=b(f.array.subarray(u+46,u+46+a.filenameLength)),a.filename=2048===(2048&a.bitFlag)?y(l):m(l),a.directory||"/"!=a.filename.charAt(a.filename.length-1)||(a.directory=!0),c=b(f.array.subarray(u+46+a.filenameLength+a.extraFieldLength,u+46+a.filenameLength+a.extraFieldLength+a.commentLength)),a.comment=2048===(2048&a.bitFlag)?y(c):m(c),d.push(a),u+=46+a.filenameLength+a.extraFieldLength+a.commentLength}o(d)},function(){t(U)})}),void 0)},close:function(e){e&&e()}}}function E(e){return unescape(encodeURIComponent(e))}function S(e){var t,n=[];for(t=0;t<e.length;t++)n.push(e.charCodeAt(t));return n}function L(e,t,n){function r(e,t){s&&s.terminate(),s=null,e&&e(t)}function o(){r(t,C)}function a(){r(t,z)}var s,l={},c=[],u=0;return{add:function(d,f,p,h,m){function y(t){var r;L=m.lastModDate||new Date,_=i(26),l[d]={headerArray:_.array,directory:m.directory,filename:k,offset:u,comment:S(E(m.comment||""))},_.view.setUint32(0,335546376),m.version&&_.view.setUint8(0,m.version),n||0===m.level||m.directory||_.view.setUint16(4,2048),_.view.setUint16(6,(L.getHours()<<6|L.getMinutes())<<5|L.getSeconds()/2,!0),_.view.setUint16(8,(L.getFullYear()-1980<<4|L.getMonth()+1)<<5|L.getDate(),!0),_.view.setUint16(22,k.length,!0),r=i(30+k.length),r.view.setUint32(0,1347093252),r.array.set(_.array,4),r.array.set(k,30),u+=r.array.length,e.writeUint8Array(r.array,t,o)}function b(t,n){var a=i(16);u+=t||0,a.view.setUint32(0,1347094280),"undefined"!=typeof n&&(_.view.setUint32(10,n,!0),a.view.setUint32(4,n,!0)),f&&(a.view.setUint32(8,t,!0),_.view.setUint32(14,t,!0),a.view.setUint32(12,f.size,!0),_.view.setUint32(18,f.size,!0)),e.writeUint8Array(a.array,function(){u+=16,r(p)},o)}function w(){return m=m||{},d=d.trim(),m.directory&&"/"!=d.charAt(d.length-1)&&(d+="/"),l.hasOwnProperty(d)?(t(R),void 0):(k=S(E(d)),c.push(d),y(function(){f?n||0===m.level?g(f,e,0,f.size,!0,b,h,a,o):s=v(f,e,m.level,b,h,a,o):b()},o),void 0)}var _,k,L;f?f.init(w,a):w()},close:function(t){var n,a,s,d=0,f=0;for(a=0;a<c.length;a++)s=l[c[a]],d+=46+s.filename.length+s.comment.length;for(n=i(d+22),a=0;a<c.length;a++)s=l[c[a]],n.view.setUint32(f,1347092738),n.view.setUint16(f+4,5120),n.array.set(s.headerArray,f+6),n.view.setUint16(f+32,s.comment.length,!0),s.directory&&n.view.setUint8(f+38,16),n.view.setUint32(f+42,s.offset,!0),n.array.set(s.filename,f+46),n.array.set(s.comment,f+46+s.filename.length),f+=46+s.filename.length+s.comment.length;n.view.setUint32(f,1347093766),n.view.setUint16(f+8,c.length,!0),n.view.setUint16(f+10,c.length,!0),n.view.setUint32(f+12,d,!0),n.view.setUint32(f+16,u,!0),e.writeUint8Array(n.array,function(){r(function(){e.getData(t)})},o)}}}var $,x="File format is not recognized.",A="File contains encrypted entry.",q="File is using Zip64 (4gb+ file size).",U="Error while reading zip file.",C="Error while writing zip file.",D="Error while writing file data.",z="Error while reading file data.",R="File already exists.",j=524288,M="inflate.js",T="deflate.js",F="text/plain",N="message";try{$=0===new Blob([new DataView(new ArrayBuffer(0))]).size}catch(W){}t.prototype.table=function(){var e,t,n,i=[];for(e=0;256>e;e++){for(n=e,t=0;8>t;t++)1&n?n=3988292384^n>>>1:n>>>=1;i[e]=n}return i}(),o.prototype=new r,o.prototype.constructor=o,a.prototype=new r,a.prototype.constructor=a,s.prototype=new r,s.prototype.constructor=s,l.prototype.getData=function(e){e(this.data)},c.prototype=new l,c.prototype.constructor=c,u.prototype=new l,u.prototype.constructor=u,d.prototype=new l,d.prototype.constructor=d,e.zip={Reader:r,Writer:l,BlobReader:s,Data64URIReader:a,TextReader:o,BlobWriter:d,Data64URIWriter:u,TextWriter:c,createReader:function(e,t,n){e.init(function(){t(k(e,n))},n)},createWriter:function(e,t,n,i){e.init(function(){t(L(e,n,i))},n)},workerScriptsPath:"",useWebWorkers:!0}}(this),define("../components/zip.js/WebContent/zip",function(e){return function(){var t;return t||e.zip}}(this)),function(e,t,n){function i(e){this.name="JsRender Error",this.message=e||"JsRender error"}function r(e,t,n){return(!Q.rTag||arguments.length)&&(C=e?"\\"+e.charAt(0):C,D=e?"\\"+e.charAt(1):D,z=t?"\\"+t.charAt(0):z,R=t?"\\"+t.charAt(0):R,n=n?"\\"+n:j,Q.rTag=x="(\\w*"+n+")?(?:(?:(\\w+(?=[\\/\\s"+z+"]))|(?:(\\w+)?(:)|(>)|(\\*)))"+"\\s*((?:[^"+z+"]|"+z+"(?!"+R+"))*?)",x=new RegExp(C+D+x+"(\\/)?|(?:\\/(\\w+)))"+z+R,"g"),A=new RegExp("<.*>|([^\\\\]|^)[{}]|"+C+D+".*"+z+R)),[C,D,z,R,j]}function o(e){var t=this,i=t.tmpl.helpers||{};return e=(t.dynCtx&&t.dynCtx[e]!==n?t.dynCtx:t.ctx[e]!==n?t.ctx:i[e]!==n?i:p[e]!==n?p:{})[e],"function"!=typeof e?e:function(){return e.apply(t,arguments)}}function a(e,t,i,r){var o=!i.markup&&i||n,a=t.tmpl.converters;return a=a&&a[e]||h[e],a?a.call(t,r,o):(m("Unknown converter: {{"+e+":"),r)}function s(e,t,i,r,o){var a,s=!i.markup&&i,l=s?s.view.tmpl:i,c=l.tags,u=l.templates,p=o.props=o.props||{},h=p.tmpl,g=arguments.length>5?K.call(arguments,5):[],y=c&&c[e]||f[e];return y?(r=r&&l.tmpls[r-1],h=h||r||y.template||n,o.view=t,h=o.tmpl=""+h===h?u&&u[h]||d[h]||d(h):h,o.attr=i.attr=i.attr||y.attr,o.tagName=e,o.renderContent=v,s&&(s.tagCtx={args:g,props:p,path:o.path,tag:y}),y.render&&(a=y.render.apply(o,g)),a||(a==n?h?o.renderContent(g[0],n,t):"":a.toString())):(m("Unknown tag: {{"+e+"}}"),"")}function l(e,t,i,r,a,s,l,c){var u,d={data:r,tmpl:a,views:c?[]:{},parent:i,ctx:e,path:t,_useKey:c?0:1,_onRender:l,_hlp:o,renderLink:function(t){var n=this.tmpl.tmpls[t];return n.render(r,e,this)}};return i&&(u=i.views,i._useKey?(u[d.key="_"+i._useKey++]=d,d.index=i.index):u.splice(d.key=d.index=s!==n?s:u.length,0,d)),d}function c(e,t,i,r,o){var a,s;if(i&&"object"==typeof i&&!i.nodeType){for(a in i)t(a,i[a]);return e}return r===n&&(r=i,i=n),(s=M.onBeforeStoreItem)&&(o=s(t,i,r,o)||o),i?""+i===i&&(null===r?delete t[i]:t[i]=o?r=o(r,i):r):r=o?o(r):r,(s=M.onStoreItem)&&s(t,i,r,o),r}function u(e,t){return e="function"==typeof e?{render:e}:e,e.name=t,e.is="tag",e}function d(e,t){return c(this,d,e,t,E)}function f(e,t){return c(this,f,e,t,u)}function p(e,t){return c(this,p,e,t)}function h(e,t){return c(this,h,e,t)}function v(e,t,i,r,o,a,s){var c,u,f,h,v,y,b,w,_,k,E,S,L=this,x="";if(r===F&&(_=F,r=0),L.tagName?(b=L.tmpl,(t||L.ctx)&&(k={},L.ctx&&q(k,L.ctx),t&&q(k,t)),t=k,w=L.props,w&&w.link===T&&(t=t||{},t.link=T),i=i||L.view,a=a||L.path,r=r||L.key,s=i&&i._onRender):(b=L.jquery&&(L[0]||m('Unknown template: "'+L.selector+'"'))||L,s=s||i&&i._onRender),b&&(i?(y=i.ctx,E=i.dynCtx,e===i&&(e=i.data,o=F)):y=p,S=t&&t!==y,(E||S)&&(y=q({},y),S&&q(y,t),E&&q(y,E)),t=y,b.fn||(b=d[b]||d(b)),b)){if(s=t.link!==T&&s,$.isArray(e)&&!o)for(h=_?i:r!==n&&i||l(t,a,i,e,b,r,s,F),c=0,u=e.length;u>c;c++)f=e[c],v=b.fn(f,l(t,a,h,f,b,(r||0)+c,s),Q),x+=s?s(v,b,w):v;else h=_?i:l(t,a,i,e,b,r,s),h._onRender=s,x+=b.fn(e,h,Q,g);return s?s(x,b,w,h.key,a):x}return m("No template found"),""}function g(e){return e}function m(e){if(Q.debugMode)throw new Q.Error(e)}function y(e){m("Syntax error\n"+e)}function b(e,t,n){function i(t){t-=c,t&&d.push(e.substr(c,t).replace(B,"\\n"))}function r(t){t&&y('Unmatched or missing tag: "{{/'+t+'}}" in template:\n'+e)}function o(t,o,l,p,h,v,g,m,y,b,w){v&&(h=":",p="html");var k,E="",S="",L=!y&&!h&&!n;l=l||h,i(w),c=w+t.length,g?s&&d.push(["*",m.replace(O,"$1")]):l?("else"===l?(f[5]=e.substring(f[5],w),f=u.pop(),d=f[3],L=F):o&&(u.push(f),f=["!",,,[],,w],d.push(f),d=f[3]),m=m?_(m,n,o).replace(H,function(e,t,n){return t?S+=n+",":E+=n+",",""}):"",E=E.slice(0,-1),m=m.slice(0,-1),a=[l,p||"",m,L&&[],"{"+(E?"props:{"+E+"},":"")+"data: data"+(S?",ctx:{"+S.slice(0,-1)+"}":"")+"}"],d.push(a),L?(u.push(f),f=a,f[5]=c):o&&(f[5]=e.substring(f[5],c),f=u.pop())):b&&(k=f[0],r(b!==k&&!("if"===b&&"else"===k)&&k),f[5]=e.substring(f[5],w),"!"===k&&(f[5]=e.substring(f[5],c),f=u.pop()),f=u.pop()),r(!f&&b),d=f[3]}var a,s=t&&t.allowCode,l=[],c=0,u=[],d=l,f=[,,,l];return e=e.replace(P,"\\$1"),r(u[0]&&u[0][3].pop()[0]),e.replace(x,o),i(e.length),w(l,t)}function w(e,t){var n,i,r,o,a,s,l,c,u,d,f,p,h,v,g,b,_,k=t?{allowCode:g=t.allowCode,debug:t.debug}:{},E=t&&t.tmpls;for(r=e.length,o=r?"":'"";',i=0;r>i;i++)n=e[i],""+n===n?o+='"'+n+'"+':(d=n[0],"*"===d?o=o.slice(0,i?-1:-3)+";"+n[1]+(r>i+1?"ret+=":""):(f=n[1],p=n[2],b=n[3],h=n[4],markup=n[5],"!"===d.slice(-1)?(v=S(markup,k,t,E.length),w(b,v),(_=/\s+[\w-]*\s*\=\s*\\['"]$/.exec(e[i-1]))&&m("'{{!' in attribute:\n..."+e[i-1]+"{{!...\nUse data-link"),o+="view.renderLink("+E.length+")+",v.bound=F,v.fn.attr=_||"leaf",E.push(v)):(b&&(v=S(markup,k,t,E.length),w(b,v),E.push(v)),u=u||h.indexOf("view")>-1,o+=(":"===d?"html"===f?(s=F,"h("+p):f?(c=F,'c("'+f+'",view,this,'+p):(l=F,"((v="+p+')!=u?v:""'):(a=F,'t("'+d+'",view,this,'+(b?E.length:'""')+","+h+(p?",":"")+p))+")+")));o=G+(l?"v,":"")+(a?"t=j._tag,":"")+(c?"c=j._convert,":"")+(s?"h=j.converters.html,":"")+"ret; try{\n\n"+(k.debug?"debugger;":"")+(g?"ret=":"return ")+o.slice(0,-1)+";\n\n"+(g?"return ret;":"")+"}catch(e){return j._err(e);}";try{o=new Function("data, view, j, b, u",o)}catch(L){y("Compiled template code:\n\n"+o,L)}return t&&(t.fn=o),o}function _(e,t,n){function i(i,c,u,d,f,p,h,v,g,m,b,w,_,k,E,S){function L(e,t,n,i,r,o,a){if(t){var s,l=(n?'view._hlp("'+n+'")':i?"view":"data")+(a?(r?"."+r:n?"":i?"":"."+t)+(o||""):(a=n?"":i?r||"":t,""));return s=a?"."+a:"",$||(l+=s),l="view.data"===l.slice(0,9)?l.slice(5):l,$&&(l="b("+l+',"'+a+'")'+s),l}return e}f=f||"",u=u||c||b,d=d||v,g=g||E||"",f=f||"";var $=(t||n)&&"("!==g;return p?(y(e),void 0):l?(l=!w,l?i:'"'):s?(s=!_,s?i:'"'):(u?(a++,u):"")+(S?a?"":r?(r=T,"\b"):",":h?(a&&y(e),r=F,"\b"+d+":"):d?d.replace(N,L)+(g?(o[++a]=F,g):f):f?f:k?(o[a--]=T,k+(g?(o[++a]=F,g):"")):m?(o[a]||y(e),","):c?"":(l=w,s=_,'"'))}var r,o={},a=0,s=T,l=T;return e=(e+" ").replace(W,i)}function k(e,t,n){var i,r;if(e)for(i in e)r=e[i],r.is||(e[i]=t(r,i,n))}function E(e,i,r,o){function a(e){if(""+e===e||e.nodeType>0){try{l=e.nodeType>0?e:!A.test(e)&&t&&t(e)[0]}catch(n){}return l&&(e=d[l.getAttribute(X)],e||(i=i||"_"+I++,l.setAttribute(X,i),e=E(l.innerHTML,i,r,o),d[i]=e)),e}}var s,l;return e=e||"",s=a(e),o=o||(e.markup?e:{}),o.name=i,o.is="tmpl",!s&&e.markup&&(s=a(e.markup))&&(!s.fn||s.debug===e.debug&&s.allowCode===e.allowCode||(s=s.markup)),s!==n?(i&&!r&&(J[i]=function(){return e.render.apply(e,arguments)}),s.fn||e.fn?s.fn&&(e=i&&i!==s.name?q(q({},s),o):s):(e=S(s,o,r,0),b(s,e)),k(o.templates,E,e),k(o.tags,u),e):void 0}function S(e,t,n,i){function r(e){n[e]&&(o[e]=q(q({},n[e]),t[e]))}t=t||{};var o={markup:e,tmpls:[],links:[],render:v};return n&&(n.templates&&(o.templates=q(q({},n.templates),t.templates)),o.parent=n,o.name=n.name+"["+i+"]",o.key=i),q(o,t),n&&(r("templates"),r("tags"),r("helpers"),r("converters")),o}function L(e){return V[e]||(V[e]="&#"+e.charCodeAt(0)+";")}if(!(t&&t.views||e.jsviews)){var $,x,A,q,U="v1.0pre",C="{",D="{",z="}",R="}",j="!",M={},T=!1,F=!0,N=/^(?:null|true|false|\d[\d.]*|([\w$]+|~([\w$]+)|#(view|([\w$]+))?)([\w$.]*?)(?:[.[]([\w$]+)\]?)?|(['"]).*\8)$/g,W=/(\()(?=|\s*\()|(?:([([])\s*)?(?:([#~]?[\w$.]+)?\s*((\+\+|--)|\+|-|&&|\|\||===|!==|==|!=|<=|>=|[<>%*!:?\/]|(=))\s*|([#~]?[\w$.]+)([([])?)|(,\s*)|(\(?)\\?(?:(')|("))|(?:\s*([)\]])([([]?))|(\s+)/g,B=/\r?\n/g,O=/\\(['"])/g,P=/\\?(['"])/g,H=/\x08(~)?([^\x08]+)\x08/g,I=0,V={"&":"&amp;","<":"&lt;",">":"&gt;"},X="data-jsv-tmpl",G="var j=j||"+(t?"jQuery.":"js")+"views,",Y=/[\x00"&'<>]/g,K=Array.prototype.slice,J={},Q={jsviews:U,sub:M,debugMode:F,render:J,templates:d,tags:f,helpers:p,converters:h,delimiters:r,View:l,_convert:a,_err:function(e){return Q.debugMode?"Error: "+(e.message||e)+". ":""},_tmplFn:b,_tag:s,error:m,Error:i};(i.prototype=new Error).constructor=i,t?($=t,$.templates=d,$.render=J,$.views=Q,$.fn.render=v):($=e.jsviews=Q,$.extend=function(e,t){var n;e=e||{};for(n in t)e[n]=t[n];return e},$.isArray=Array&&Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)}),q=$.extend,f({"if":function(){var e=this,t=e.view;return t.onElse=function(e,i){for(var r=0,o=i.length;o&&!i[r++];)if(r===o)return"";return t.onElse=n,e.path="",e.renderContent(t)},t.onElse(this,arguments)},"else":function(){var e=this.view;return e.onElse?e.onElse(this,arguments):""},"for":function(){var e,t=this,n="",i=arguments,r=i.length;for(0===r&&(r=1),e=0;r>e;e++)n+=t.renderContent(i[e]);return n},"*":function(e){return e}}),h({html:function(e){return e!=n?String(e).replace(Y,L):""}}),r()}}(this,this.jQuery),define("vendor/jsrender/jsrender",function(e){return function(){var t;return t||e.jsviews}}(this)),function(e){e.Trigger={addEventListener:function(e,t){void 0===this.event_listeners&&(this.event_listeners={}),void 0===this.event_listeners[e]&&(this.event_listeners[e]=[]),this.event_listeners[e].push(t)},trigger:function(e,t){if("string"==typeof e&&(e=new Event(e)),void 0!==t)for(var n in t)e[n]=t[n];console.info(this,e),void 0!==this.event_listeners&&void 0!==this.event_listeners[e.type]&&this.event_listeners[e.type].forEach(function(t){t.call(this,e)}.bind(this))}}}(window),define("trigger",function(e){return function(){var t;return t||e.Trigger}}(this)),function(e){var t=function(){var e;return{init:function(){var t=indexedDB.open("library",1);t.addEventListener("success",function(t){var n=[];e=t.target.result,this.trigger("initied");var i=e.transaction("metadata");i.addEventListener("complete",function(){this.trigger("changed",{$ebooks:n})}.bind(this)),i.objectStore("metadata").openCursor().addEventListener("success",function(e){var t=e.target.result;null!==t&&void 0!==t&&(n.push(t.value),t.continue())})}.bind(this)),t.addEventListener("upgradeneeded",function(e){switch(e.oldVersion){case 0:this.result.createObjectStore("files"),this.result.createObjectStore("metadata"),this.result.createObjectStore("settings")}})},identifiers:function(t){var n=[],i=e.transaction("metadata");i.addEventListener("complete",function(){t(n)}),i.objectStore("metadata").openCursor().addEventListener("success",function(e){var t=e.target.result;null!==t&&void 0!==t&&(n.push(t.key),t.continue())})},list:function(t){var n={},i=e.transaction("metadata");i.addEventListener("complete",function(){t(n)}),i.objectStore("metadata").openCursor().addEventListener("success",function(e){var t=e.target.result;null!==t&&void 0!==t&&(n[t.key]=t.value,t.continue())})},"delete":function(t){var n=e.transaction(["metadata","files"],"readwrite"),i=[];n.addEventListener("complete",function(){this.trigger("deleted",{$identifier:t}),this.trigger("changed",{$ebooks:i})}.bind(this)),n.objectStore("metadata").delete(t),n.objectStore("files").delete(t),n.objectStore("metadata").openCursor().addEventListener("success",function(e){var t=e.target.result;null!==t&&void 0!==t&&(i.push(t.value),t.continue())})},save:function(t,n,i){this.trigger("adding");var r=e.transaction(["metadata","files"],"readwrite"),o=[];n.identifier.value=t,n.type=i.type,r.addEventListener("complete",function(){this.trigger("added",{$identifier:t,$metadata:n}),this.trigger("changed",{$ebooks:o})}.bind(this)),r.objectStore("metadata").put(n,t),r.objectStore("files").put(i,t),r.objectStore("metadata").openCursor().addEventListener("success",function(e){var t=e.target.result;null!==t&&void 0!==t&&(o.push(t.value),t.continue())})},load:function(t,n){var i,r,o=e.transaction(["metadata","files"],"readonly"),a=o.objectStore("files").get(t),s=o.objectStore("metadata").get(t);a.addEventListener("success",function(e){r=e.target.result}),s.addEventListener("success",function(e){i=e.target.result}),o.addEventListener("complete",function(){var e,t;void 0!==i&&(e=WR.handler(i.type)),void 0!==e&&void 0!==r&&(t=e.factory(r)),n(t,i)})},metadata:function(t,n){var i=e.transaction(["metadata"],"readonly");i.objectStore("metadata").get(t).addEventListener("success",function(e){n(e.target.result)})},get_ebook_settings:function(t,n){var i=e.transaction(["settings"],"readonly");i.objectStore("settings").get(t).addEventListener("success",function(){n(this.result||{})})},set_ebook_settings:function(t,n,i){var r,o=e.transaction(["settings"],"readwrite");o.addEventListener("complete",function(){"function"==typeof i&&i(r)}.bind(this)),o.objectStore("settings").get(t).addEventListener("success",function(){r=this.result||{};for(var e in n)r[e]=n[e];o.objectStore("settings").put(r,t)})},addEventListener:Trigger.addEventListener,trigger:Trigger.trigger}}();e.WR=function(){var n,i,r,o={},a=function(){window.wr=this,s.call(this,this.default_settings,"general","General")},s=function(e,t,n){void 0===this.$settings_def&&(this.$settings_def={},a.call(this)),void 0===this.$settings_def[t]&&(this.$settings_def[t]={label:n,list:e.map(function(e){return e.category=t,e})})},l=function(e,t,n){this.trigger("open",{$metadata:e.metadata(),$ebook:e,$spine:t,$hash:n})};return{init:function(){this.library().addEventListener("initied",function(){this.trigger("initied")}.bind(this)),this.library().init()},formats:function(){var e={};for(var t in o)e[t]=o[t].name;return e},register:function(e,t,n){o[e]={factory:t,name:n},"function"==typeof t.settings_def&&s(t.settings_def(),n)},handler:function(e){return o[e]},build:function(t){var n=e.WR.handler(t.type);return void 0!==n?n.factory(t):void 0},library:function(){return void 0===n&&(n=Object.create(t)),n},open:function(e,t,n){i===e?l(r,t,n).bind(this):this.library().load(e,function(e){l.call(this,e,t,n)}.bind(this))},settings_def:function(){return void 0===this.$settings_def&&(this.$settings_def={},a.call(this)),this.$settings_def},get_settings:function(e,t,n){var i=this.settings_def(),r={};for(var o in i)for(var a=0;a<i[o].list.length;a++){var s=i[o].list[a];r[o+"."+s.name]=s.default_value}this.library().get_ebook_settings(0,function(i){var o=function(n){var r,o={};if(void 0!==e)for(var a=0;a<e.length;a++)r=e[a],o[r]=void 0===n[r]?i[r]:n[r];else{for(r in i)o[r]=i[r];for(r in n)o[r]=n[r]}for(var s in o){var l=s.split(".",2)[0];r=s.slice(l.length+1),void 0===o[l]&&(o[l]={}),o[l][r]=o[s],delete o[s]}t(o)};for(var a in r)void 0===i[a]&&(i[a]=r[a]);void 0===n?o({}):this.library().get_ebook_settings(n,o)}.bind(this))},set_settings:function(e,t,n,i){void 0===i?this.library().set_ebook_settings(0,e,t,n):this.library().set_ebook_settings(i,e,t,n)},addEventListener:Trigger.addEventListener,trigger:Trigger.trigger}}()}(window),define("web-reader",["trigger"],function(e){return function(){var t;return t||e.WR}}(this)),function(e){var t={cache:function(e,t){return function(){var n,i=Array.prototype.pop.call(arguments);"string"==typeof t?(void 0===this[t]&&(this[t]={}),n=this[t]):n=t.apply(this,arguments),void 0===n.$loaded?(n.$loaded=!1,n.$callbacks=[i],Array.prototype.push.call(arguments,function(){for(n.$data=arguments,n.$loaded=!0;0!==n.$callbacks.length;)n.$callbacks.shift().apply(this,n.$data)}.bind(this)),e.apply(this,arguments)):n.$loaded!==!0?n.$callbacks.push(i):i.apply(this,n.$data)}},forEach:function(e,t,n){var i=e instanceof Array||e instanceof NodeList,r=i?e:[e],o="function"!=typeof t,a=[],s=[],l=r.length,c="function"==typeof n?function(e,r,c){if(o){void 0===s[e]&&(s[e]={},a[e]={}),s[e][r]=c,a[e][r]=!0;var u=!0;for(var d in t)a[e][d]!==!0&&(u=!1);u&&l--}else s[e]=c,l--;0===l&&n(i?s:s[0])}:function(){};o||(t={value:t}),Array.prototype.forEach.call(r,function(e,n){for(var i in t)t[i](e,function(e,t){return function(n){c(e,t,n)}}(n,i),n)})}};e.Utils=t}(window),define("utils",function(e){return function(){var t;return t||e.Utils}}(this)),function(e){var t=[],n={};window.$servers=t;var i={register:function(e){var n=Object.create(r,{$uri:{value:e}});t.push(n)},servers:function(){return t},server:function(e){return n[e]}},r={get:function(e,t){var n=document.createElement("a");n.href=e,n.host===window.location.host&&this.$uri!==location.origin&&(n.href="http://"+this.host()+e);var i=this,r=new XMLHttpRequest({mozSystem:!0});r.open("GET",n.href),r.responseType="document",r.onreadystatechange=function(){4===this.readyState&&(200===this.status?(void 0===i.$host&&(i.$host=n.host),t(this.response)):t(null))},r.send()},host:function(){return this.$host||""},root:Utils.cache(function(e){this.get(this.$uri,function(t){if(null===t)e(t);else{var i=function(t){var i=t.querySelector("feed > id");i&&(n[i.textContent]=this),e(t)}.bind(this),r=t.querySelector('feed > link[rel=start],head > link[type="application/atom+xml;profile=opds-catalog"],head > link[type="application/atom+xml;profile=opds-catalog;kind=navigation"]');null!==r&&(r=r.getAttribute("href")),null!==r&&this.$uri!==r?this.get(r,i):i(t)}}.bind(this))},"$root"),id:function(e){this.root(function(t){var n=null;null!==t&&(n=t.querySelector("feed > id")),null!==n&&(n=n.textContent),e(n)})},title:function(e){this.root(function(t){if(null===t)e(null);else{var n=t.querySelector("feed > title"),i=t.querySelector("feed > subtitle");e(n?n.textContent:null,i?i.textContent:null)}})},icon:function(e){this.root(function(t){if(null===t)e(null);else{var n=t.querySelector("feed > icon");e(n?n.textContent:null)}})},searchengine:function(e){void 0===this.$searchengine?this.root(function(t){if(null===t)e(null);else{var n=t.querySelector('feed > link[rel=search][type="application/opensearchdescription+xml"]');null===n?(this.$searchengine=null,e(null)):this.get(n.getAttribute("href"),function(t){this.$searchengine=t,e(t)}.bind(this))}}.bind(this)):e(this.$searchengine)}};e.OPDS=i}(window),define("opds",["utils"],function(e){return function(){var t;return t||e.OPDS}}(this)),!window.ArchiveReader){var Request={addEventListener:function(e,t){void 0===this.$listeners&&(this.$listeners={}),void 0===this.$listeners[e]&&(this.$listeners[e]=[]),this.$listeners[e].push(t)}},ArchiveReader=function(e){this.$blob=e};ArchiveReader.polyfill=!0,ArchiveReader.prototype={reader:Utils.cache(function(e){zip.createReader(new zip.BlobReader(this.$blob),e)},"$reader"),entries:Utils.cache(function(e){this.reader(function(t){t.getEntries(e)})},"$entries"),entryids:Utils.cache(function(e){this.entries(function(t){for(var n={},i=0;i<t.length;i++)n[t[i].filename]=i;e(n)})},"$entryids"),entryid:Utils.cache(function(e,t){this.entryids(function(n){t(n[e])})},function(e){return void 0===this.$entryid&&(this.$entryid={}),void 0===this.$entryid[e]&&(this.$entryid[e]={}),this.$entryid[e]}),entry:Utils.cache(function(e,t){this.entryid(e,function(e){this.entries(function(n){t(n[e])})}.bind(this))},function(e){return void 0===this.$entry&&(this.$entry={}),void 0===this.$entry[e]&&(this.$entry[e]={}),this.$entry[e]}),getFile:function(e){var t=Object.create(Request),n=function(){this.entry(e,function(e){return void 0===e?(t.result=null,trigger(t,"error"),void 0):(e.getData(new zip.BlobWriter,function(e){t.result=e,trigger(t,"success")}),void 0)}.bind(this))}.bind(this);return setTimeout(n,0),t},getFilenames:function(){console.warn("not implemented")}},window.ArchiveReader=ArchiveReader}define("archivereader",["utils"],function(e){return function(){var t;return t||e.ArchiveReader}}(this)),function(e){var t=function(){jsviews.helpers({epub_navuri:function(e){return e.querySelector("content").getAttribute("src")}}),jsviews.tags({epub_navPoints:function(e){for(var t=[],n=0;n<e.children.length;n++)"navPoint"===e.children[n].tagName&&t.push(e.children[n]);return this.renderContent(t,void 0,void 0,void 0,!0)}});var e=function(e,t,n,i){e.all("link[href],image,img[src]",function(r){Utils.forEach(r,function(e,n){var i={link:"href",image:"xlink:href",img:"src"}[e.nodeName],r=e.getAttribute(i);this.file(t+r,function(t){if(null!==t)switch(e.nodeName){default:e.setAttribute(i,URL.createObjectURL(t.$blob))}n()})}.bind(this),function(){e.xmldoc(function(e){n((new XMLSerializer).serializeToString(e),i)}.bind(this))}.bind(this))}.bind(this))},t=function(e,t){render_template("epub-toc-item",void 0,function(){render_template("epub-toc",e.documentElement,function(e){t(e)})})};return{toc:function(e){this.rootfile(function(n){n.one("spine[toc]",function(i){n.one('[id="'+i.getAttribute("toc")+'"]',function(n){this.rootfile_dir(function(i){this.file(i+n.getAttribute("href"),function(n){n.xmldoc(function(n){t(n,e)})})}.bind(this))}.bind(this))}.bind(this))}.bind(this))},prev_next:function(e,t){this.rootfile(function(n){n.xmldoc(function(n){for(var i=n.querySelector('manifest item[href="'+e+'"]'),r=i.getAttribute("id"),o=n.querySelector('spine itemref[idref="'+r+'"]'),a=null===o?null:o.previousElementSibling,s=null===o?null:o.nextElementSibling;null!==a&&"no"===a.getAttribute("linear");)a=a.previousElementSibling;for(;null!==s&&"no"===s.getAttribute("linear");)s=s.nextElementSibling;var l=null===a?null:a.getAttribute("idref"),c=null===s?null:s.getAttribute("idref"),u=null===l?null:n.querySelector('manifest item[id="'+l+'"]'),d=null===c?null:n.querySelector('manifest item[id="'+c+'"]'),f=null===u?null:u.getAttribute("href"),p=null===d?null:d.getAttribute("href");t(f,p)})})},spine:Utils.cache(function(t,n){var i=function(t,i){this.file(i+t,function(r){e.call(this,r,i,n,t)}.bind(this))}.bind(this);this.rootfile_dir(function(e){void 0===t?this.rootfile(function(t){t.one('spine itemref:not([linear="no"])',function(n){t.one('[id="'+n.getAttribute("idref")+'"]',function(t){i(t.getAttribute("href"),e)}.bind(this))})}.bind(this)):i(t,e)}.bind(this))},function(e){return void 0===this.$spines&&(this.$spines={}),void 0===this.$spines[e]&&(this.$spines[e]={}),this.$spines[e]}),item:function(){this.rootfile(function(){}.bind(this))},itemrefs:Utils.cache(function(e){this.rootfile(function(t){t.all("spine itemref",e)}.bind(this))},"$itemrefs"),title:function(e){this.metadata(function(t){var n=t.length>0?t[0].value:null;e(n)},"title")},metadata:function(e,t){var n=t,i={identifier:"identifier",title:"title",language:"language",contributor:"contributor",coverage:"coverage",creator:"creator",date:"date",description:"description",format:"format",publisher:"publisher",relation:"relation",rights:"rights",source:"source",subject:"subject",type:"type",series_index:'meta[name="calibre:series_index"]',series:'meta[name="calibre:series"]'};
if("string"==typeof n&&(n=[n]),void 0===n){n=[];for(var r in i)n.push(r)}this.rootfile(function(r){var o={},a=function(){if(0===n.length)e("string"==typeof t?o[t]:o);else{var s=n.pop(),l=void 0===i[s]?s:i[s];r.all("metadata > "+l,function(e){o[s]=Array.prototype.map.call(e,function(e){var t=e.textContent,n=e.getAttribute("id"),i=e.getAttribute("lang"),r=e.getAttribute("dir");return"meta"===e.nodeName&&null===e.firstChild&&(t=e.getAttribute("content")),{value:t,id:null===n?void 0:n,lang:null===i?void 0:i,dir:null===r?void 0:r}}),a()})}};a()})},identifier:function(e){this.rootfile(function(t){t.xmldoc(function(n){var i=n.documentElement.getAttribute("unique-identifier");t.one('identifier[id="'+i+'"],identifier',function(t){var n=null===t?null:t.textContent;e(n)})})})},version:function(e){this.rootfile(function(t){t.xmldoc(function(t){var n=t.documentElement.getAttribute("version");e(n)})})},rootfile:Utils.cache(function(e){this.rootfile_path(function(t){this.file(t,e)}.bind(this))},"$rootfile"),rootfile_dir:function(e){this.rootfile_path(function(t){var n=t.lastIndexOf("/"),i=-1===n?"":t.slice(0,n+1);e(i)})},rootfile_path:Utils.cache(function(e){this.container(function(t){t.one("container rootfiles rootfile",function(t){e(null===t?null:t.getAttribute("full-path"))}.bind(this))}.bind(this))},"$rootfile_path"),container:function(e){this.file("META-INF/container.xml",e)},file:Utils.cache(function(e,t){e=e.replace("/../","/");var n=this.reader().getFile(e);n.addEventListener("success",function(e){t(i(e.target.result))}.bind(this)),n.addEventListener("error",function(){t(null)}.bind(this))},function(e){return e=e.replace("/../","/"),void 0===this.$files&&(this.$files={}),void 0===this.$files[e]&&(this.$files[e]={}),this.$files[e]}),filenames:Utils.cache(function(e){var t=this.reader().getFilenames();t.addEventListener("success",function(t){e(t.target.result)}.bind(this)),t.addEventListener("error",function(){e(null)}.bind(this))},"$filenames"),reader:function(){return void 0===this.$reader&&(this.$reader=new ArchiveReader(this.$blob)),this.$reader}}}(),n={dataURL:Utils.cache(function(e){var t=new FileReader(this.$blob);t.addEventListener("load",function(t){e(t.target.result)}.bind(this)),t.addEventListener("error",function(){e(null)}.bind(this)),t.readAsDataURL(this.$blob)},"$dataURL"),type:function(){return this.$blob.type},data:Utils.cache(function(e){var t=new FileReader;t.addEventListener("load",function(t){e(t.target.result)}.bind(this)),t.addEventListener("error",function(){e(null)}.bind(this)),t.readAsText(this.$blob)},"$data"),xmldoc:Utils.cache(function(e){this.data(function(t){null!==t?e((new DOMParser).parseFromString(t,"text/xml")):e(null)}.bind(this))},"$xmldoc"),one:function(e,t){this.xmldoc(function(n){t(n.querySelector(e))})},all:function(e,t){this.xmldoc(function(n){t(n.querySelectorAll(e))})}},i=function(e){return Object.create(n,{$blob:{value:e}})},r=function(e){return Object.create(t,{$blob:{value:e}})};e.register("application/epub+zip",r,"epub")}(WR),define("epub",["web-reader","archivereader","utils"],function(){}),requirejs.config({shim:{"../components/zip.js/WebContent/zip":{exports:"zip"},"vendor/jsrender/jsrender":{exports:"jsviews"},"web-reader":{exports:"WR",deps:["trigger"]},trigger:{exports:"Trigger"},opds:{exports:"OPDS",deps:["utils"]},utils:{exports:"Utils"},archivereader:{exports:"ArchiveReader",deps:["utils"]},epub:{deps:["web-reader","archivereader","utils"]}}}),require(["../components/zip.js/WebContent/zip","vendor/jsrender/jsrender","web-reader","opds","utils","epub"],function(e,t,n,i,r){var o=document.querySelector("#library"),a=(document.querySelector("#settings"),document.querySelector("#ebook")),s=document.querySelector("#toc"),l=document.querySelector("#ebook-settings"),c=document.querySelector("#overlay"),u=o.querySelector("input[name=filter]");e.workerScriptsPath="js/vendor/min/",t.helpers({ebook_formats:n.formats}),t.tags({each:function(e){var t=[];for(var n in e)t.push({key:n,value:e[n]});return this.renderContent(t)},selector:function(e,t){void 0===t&&(t=this.data);var n=t.querySelector(e);return null===n?"":this.renderContent(n)},ifselector:function(e,t){void 0===t&&(t=this.data);var n=t.querySelector(e);return null===n?"":this.renderContent(t)},selectorAll:function(e,t){void 0===t&&(t=this.data);for(var n=t.querySelectorAll(e),i=[],r=0;r<n.length;r++)i.push(n[r]);return this.renderContent(i)}}),t.converters({attr:function(e){return void 0!==e?String(e).replace('"',"&quot;").replace("&","&amp;"):""}});var d=[{name:"save_reading_position",label:"Remember reading position",type:"checkbox",default_value:!0},{name:"page_scrolling_direction",label:"Page scrolling direction",type:"radio",values:{horizontal:"Horizontal",vertical:"Vertical"},default_value:"vertical",force:function(e){return"horizontal"===e?{general:{continuous_scrolling:!1}}:{}}},{name:"continuous_scrolling",label:"Scroll continuously",type:"checkbox",default_value:!0,force:function(e){return e?{general:{page_scrolling_direction:"vertical"}}:{}}},{name:"page_animation",label:"Page animation",type:"radio",values:{slide:"Slide",shift:"Shift"},default_value:"slide"},{name:"screen_orientation",label:"Screen orientation",type:"radio",default_value:"portrait",values:{system:"System",portrait:"Portrait",landscape:"Landscape"},onchange:function(e){return"system"!==e?screen.mozLockOrientation(e):screen.mozUnlockOrientation()},disabled:void 0===screen.mozLockOrientation?"Not supported on your device":!1}],f=Object.create(n,{default_settings:{value:d}}),p=function(){var e=function(e,t,n){for(var i=[],r="",o=0;void 0!==e[o];){var a=e[o];a===t?(i.push(r),r=""):(a===n&&(a=e[++o]),r+=a),o++}return i.push(r),i=i.map(function(e){return""===e?void 0:e})};return function(t){return e(t,"@","\\")}}(),h=function(e,t){e.metadata(function(e){t(e)})},v=function(e){var t=f.build(e);return void 0===t?(alert("EBook format [type] is not supported".replace("[type]",e.type)),y(),void 0):(t.identifier(function(e){v.import_ebook(t,e),y()}),void 0)};v.import_ebook=function(e,t){f.library().list(function(n){void 0!==n[t]?v.identifier_exists(e,t,n,n[t],function(t){h(e,function(n){f.library().save(t,n,e.$blob)})}):h(e,function(n){f.library().save(t,n,e.$blob)})})},v.identifier_exists=function(e,t,n,i,r){g("checking identifier"),render_template("library-identifier-exists",i,function(o){var a=m(o);a.querySelector("#identifier-exists-update").addEventListener("click",function(){y(),r(t)}),a.querySelector("#identifier-exists-new").addEventListener("click",function(){v.identifier_resolve(e,t,n,i,r)}),a.querySelector("#identifier-exists-update-other").addEventListener("click",function(){v.update_ebook(e,t,n,i,r)})})},v.update_ebook=function(e,t,n,i,r){g("loading ebooks list"),render_template("library-identifier-select-ebook",n,function(e){var t=m(e);t.querySelector("#library-select-identifier-filter").addEventListener("input",function(){var e,n,i=t.querySelector("#library-select-identifiers"),r=new RegExp(this.value,"gi");Array.prototype.forEach.call(i.querySelectorAll("option"),function(t){""!==t.value?(t.innerHTML=t.dataset.label.replace(r,"<b>$&</b>"),-1===t.dataset.label.toLowerCase().search(r)?(t.style.display="none",i.value===t.value&&(i.value="")):(void 0===e&&(e=t),t.style.display="")):n=t}),void 0===e?n.textContent=n.dataset.nomatch:(""===i.value&&(i.value=e.value),n.textContent=n.dataset.label)}),t.querySelector("#library-select-identifier-filter").focus(),t.querySelector("#library-select-identifier").addEventListener("submit",function(e){e.preventDefault(),y(),r(this.identifier.value)})})},v.identifier_resolve=function(e,t,n,i,r){g("generating identifier");var o=t+"-";do o+=Math.floor(10*Math.random());while(void 0!==n[o]);render_template("library-identifier-resolve-conflict",{"new":o,old:t},function(e){var t=m(e),i=t.querySelector("input"),o=function(){void 0!==n[i.value]?i.setCustomValidity("This identifier already exists: "+n[i.value].title[0].value):i.setCustomValidity("")};t.querySelector("#library-resolve-identifier-conflict").addEventListener("submit",function(e){e.preventDefault(),y(),r(this["new-identifier"].value)}),t.querySelector("[type=reset]").addEventListener("click",function(){window.setTimeout(o,1)}),t.querySelector("input").addEventListener("input",o)})};var g=function(e,t,n){if(c.innerHTML=e||"loading overlay content",t!==!1){var i=document.createElement("button");i.textContent=t||"Abort",i.className="close-overlay",i.addEventListener("click",function(){y(),void 0!==n&&n()}),c.appendChild(i)}c.classList.add("loading"),c.style.left=0},m=function(e,t){return c.innerHTML=e,c.classList.remove("loading"),Array.prototype.forEach.call(c.querySelectorAll(".close-overlay"),function(e){e.addEventListener("click",function(e){e.preventDefault(),void 0===t?y():t()})}),c},y=function(){c.style.left=""},b=function(e,t,n,i){var r;do r=n,n=n.replace(/[^\/]*\/\.\.\//g,"");while(r!==n);return n=n.replace("@","\\@","g"),n=n.replace(/#(.*)/,"@$1","g"),i=void 0===i?"":"@"+i,e+"/"+t+"@"+n+(-1===r.search("#")?"@":"")+i},w=function(){if(window===window.top){var e=window.location.hash.substr(1),t=e.search("/"),n=-1===t?e:e.substr(0,t),i=-1===t?void 0:e.substr(t+1);Array.prototype.forEach.call(document.querySelectorAll(".target"),function(e){e.classList.remove("target")}),Array.prototype.forEach.call(document.querySelectorAll("a[data-prefix]"),function(e){e.href=void 0===i?"#"+e.dataset.prefix:"#"+e.dataset.prefix+"/"+i}),""===n&&(n="library"),void 0!==w[n]&&(void 0!==i?x(i,w[n]):w[n]());var r=document.querySelector("#"+n);null!==r&&r.classList.add("target")}};w.library=function(){},w.bookmarks=function(){},w.settings=function(){var e=document.querySelector("#settings .content"),t=f.settings_def(),n=function(e,n){if(void 0===t[e])return void 0;for(var i=0;i<t[e].list.length;i++)if(t[e].list[i].name===n)return t[e].list[i]},i=function(t,i,r){var o=n(t,i);switch(o.type){case"checkbox":e.querySelector("input[name="+o.name+"]").checked=r;break;case"radio":e.querySelector("input[name="+o.name+"][value="+r+"]").checked=!0}e.querySelector('[data-setting_name="'+t+"."+i+'"]').old_value=r},r=function(t,r){var o=function(e,t,i){var r=t.force?t.force(i):{};for(var a in r)for(var s in r[a])o.call(this,e,n(a,s),r[a][s]);return e[t.category+"."+t.name]=i,t.onchange&&t.onchange(i),e};return function(a){var s=r.call(this,a),l=o.call(this,{},t,s.new_value);f.set_settings(l,function(){for(var t in l){var r=t.split(".",2)[0],o=t.slice(r.length+1);n(r,o),e.querySelector('[data-setting_name="'+r+"."+o+'"]').value!==l[t]&&i(r,o,l[t])}},function(){console.warn("saving settings failed, should reload settings values")})}},o=e.querySelector("ul");if(null===o){o=document.createElement("ul"),o.settings_names=[],o.classList.add("settings-list");for(var a in t){var s=t[a],l=document.createElement("li"),c=document.createElement("h2"),u=document.createElement("ul");c.textContent=s.label;for(var d=0;d<s.list.length;d++){var p,h,v,g,m=s.list[d],y=document.createElement("li"),b=document.createElement("h3"),w="string"==typeof m.disabled;if(y.classList.add("type-"+m.type),y.classList.add("setting-item"),y.dataset.setting_name=a+"."+m.name,o.settings_names.push(y.dataset.setting_name),b.textContent=m.label,w){var _=document.createElement("span");_.textContent=m.disabled,b.appendChild(_),y.classList.add("disabled")}switch(m.type){case"checkbox":h=document.createElement("label"),p=document.createElement("input"),p.name=m.name,p.type=m.type,p.disabled=w,p.input_value=y,p.addEventListener("change",r(m,function(){return{new_value:this.checked,old_value:!this.checked}})),h.appendChild(b),h.appendChild(p),y.appendChild(h);break;case"radio":y.appendChild(b),v=document.createElement("ul");for(var k in m.values)g=document.createElement("li"),h=document.createElement("label"),p=document.createElement("input"),p.name=m.name,p.type=m.type,p.value=k,p.disabled=w,p.input_value=y,p.addEventListener("change",r(m,function(){return{new_value:this.value,old_value:this.input_value.old_value}})),h.textContent=m.values[k],h.appendChild(p),g.appendChild(h),v.appendChild(g);y.appendChild(v)}u.appendChild(y)}l.appendChild(c),l.appendChild(u),o.appendChild(l)}e.appendChild(o)}f.get_settings(o.settings_names,function(e){for(var t in e)for(var n in e[t])i(t,n,e[t][n])}),"undefined"===document.documentElement.dataset.installed&&Modernizr.apps===!0&&D(function(e){if(document.documentElement.dataset.installed=null!==e,null!==e){var t=new XMLHttpRequest;null!==e.manifest&&(t.open("GET",e.manifestURL),t.responseType="json",t.onreadystatechange=function(){4===this.readyState&&(document.documentElement.dataset.uptodate=this.response.version===e.manifest.version)},t.send())}})},w.import=function(){var e=document.querySelector("#import_ebook_internet select:empty");if(null!==e){var t=document.createElement("option");e.appendChild(t);var n=f.formats();for(var o in n)t=document.createElement("option"),t.value=o,t.textContent=n[o],e.appendChild(t)}"true"!==document.querySelector("#opds").dataset.loaded&&(document.querySelector("#opds").dataset.loaded="true",r.forEach(i.servers(),{title:function(e,t){e.title(function(e,n){t({main:e,sub:n})})},icon:function(e,t){e.icon(t)},id:function(e,t){e.id(t)}},function(e){e=Array.prototype.filter.call(e,function(e){return null!==e.id}),render_template("opds-server-list",{servers:e},function(e){document.querySelector("#opds").innerHTML=e,Array.prototype.forEach.call(document.querySelectorAll("#opds li button"),function(e){e.addEventListener("click",function(){z(i.server(e.dataset.serverid),null)})})})}))},w["ebook-bookmarks"]=function(){},w["ebook-settings"]=function(){delete l.dataset.ebookid},w.toc=function(e,t){w.toc.$ebook_id!==t&&(w.toc.$ebook_id=t,e.toc(function(e){s.querySelector(".content").innerHTML=e,s.dataset.ebook_id=t}))},w.ebook=function(e,t,n,i,r){if(void 0===e)return alert("Could not load the book."),window.location.hash="library",void 0;var o=a.querySelector("iframe.top");o.onload=void 0,(w.ebook.$ebook_id!==t||w.ebook.$ebook_spine!==n)&&w.ebook.render(o,"loading…"),f.get_settings(void 0,function(o){var s,l,c=a.querySelector("iframe.top"),u=function(){w.ebook.init(e,t,n,i,r,o,c,function(){u="done",void 0!==s&&s()})},d=function(){"done"!==u?s=d:(w.ebook.move_to_hash(c,i,r,o),void 0!==l&&l(),$(t,n,i,o))};if(w.ebook.$ebook_id===t&&w.ebook.$ebook_spine===n)return u(),d(),void 0;var f=w.ebook.return_to_reading_position(o,t,n,i,c);f!==!1&&(n=f.spine,l=f.onrendered),c.onload=d,e.spine(n,function(e,i){var r=a.querySelector("iframe.top"),o=a.querySelector("iframe.current:not(.top)");w.ebook.render(r,e,t),w.ebook.render(o,e,t),w.ebook.$ebook_id=t,w.ebook.$ebook_spine=n,w.ebook.$ebook_spine_real=i,u()})},t)};var _=function(e){return e["BackCompat"===e.compatMode?"body":"documentElement"]};w.ebook.init_scrolling=function(e,t,n,i,r,o){var s={height:"100%",MozColumnWidth:"99999rem",MozColumnGap:"0",overflow:"hidden",zIndex:0,left:"",top:""},l=function(e){for(var o in s)e.contentDocument.documentElement.style[o]=r.general.continuous_scrolling===!1?s[o]:"";var l={began:!1,in_progress:!1,origin:null,last:null,speed:null,delta:null},c="horizontal"===r.general.page_scrolling_direction?"left":"top",u="horizontal"===r.general.page_scrolling_direction?"scrollLeft":"scrollLeft",d="horizontal"===r.general.page_scrolling_direction?"screenX":"screenY",f=function(e){e.preventDefault(),l.began=!0,l.last=l.origin=e[d]||e.touches[0][d],l.delta=l.speed=0},p=function(t){if(l.began){t.preventDefault();var n=t[d]||t.touches[0][d];l.speed=n-l.last,l.last=n,l.delta=l.last-l.origin;var i=l.delta<0,o=_(e.contentDocument)[u],s=_(e.contentDocument)[u+"Max"],f=e.contentDocument.documentElement.clientWidth,p=e.contentDocument.documentElement["horizontal"===r.general.page_scrolling_direction?"clientWidth":"clientHeight"],h=o+f*(i?1:-1),v=0>h,g=h>s;if(Math.abs(l.delta)>10&&(l.in_progress=!0),l.in_progress){t.preventDefault();var m=a.querySelector(v?"iframe.prev":g?"iframe.next":"iframe.current:not(.top)"),y=.5*p;Array.prototype.forEach.call(a.querySelectorAll("iframe.under"),function(e){e.classList.remove("under")}),m.classList.add("under"),v&&void 0===m.dataset.spine&&(l.delta=Math.min(l.delta,Math.round(p/3))),g&&void 0===m.dataset.spine&&(l.delta=Math.max(l.delta,-Math.round(p/3))),Math.abs(l.delta+l.speed)>y?e.classList.add("swiped-enough"):e.classList.remove("swiped-enough"),_(m.contentDocument)[u]=_(e.contentDocument)[u]+f*(i?1:-1),e.style[c]=l.delta+"px","slide"!==r.general.page_animation&&(m.style[c]=l.delta+p*(i?1:-1)+"px")}}},h=function(){if(l.in_progress){var o=l.delta>0,s=a.querySelector("iframe.under"),u=e.contentDocument.documentElement["horizontal"===r.general.page_scrolling_direction?"clientWidth":"clientHeight"],d=.5*u,f=Math.abs(l.delta+l.speed)>d;f&&(void 0!==s.dataset.spine?(e.classList.remove("top"),a.querySelector("iframe.current").classList.add("top"),window.location.hash=b("ebook",t,s.dataset.spine,o?"lastpage":void 0)):(s.classList.add("top"),e.classList.remove("top"),$(t,n,i,r))),e.classList.remove("swiped-enough"),s.classList.remove("under"),s.style[c]="",e.style[c]=""}l.began=!1,l.in_progress=!1};e.contentDocument.ontouchstart=e.contentDocument.onmousedown=r.general.continuous_scrolling===!1?f:void 0,e.contentDocument.ontouchmove=e.contentDocument.onmousemove=r.general.continuous_scrolling===!1?p:void 0,e.contentDocument.ontouchcancel=e.contentDocument.ontouchleave=e.contentDocument.ontouchend=e.contentDocument.onmouseup=r.general.continuous_scrolling===!1?h:void 0},c=a.querySelectorAll("iframe");if("slide"===r.general.page_animation?a.querySelector(".content").classList.add("uncover-pages"):a.querySelector(".content").classList.remove("uncover-pages"),r.general.continuous_scrolling===!1){var u=a.querySelector("iframe.current:not(.top)");l(u),e.prev_next(w.ebook.$ebook_spine_real,function(e,t){var n="",i="vertical"===r.general.page_scrolling_direction?"<style>body {position: absolute; bottom: 0;}":"",s=a.querySelector("iframe.prev"),l=a.querySelector("iframe.next");s.contentDocument.open(),s.contentDocument.write((null!==e?"Pull to load previous spine.":"You're at the beginning.")+n),s.contentDocument.close(),l.contentDocument.open(),l.contentDocument.write((null!==t?"Pull to load next spine.":"You're done. Time to open another book.")+i),l.contentDocument.close(),null!==e?s.dataset.spine=e:delete s.dataset.spine,null!==t?l.dataset.spine=t:delete l.dataset.spine,o()})}else{var d=a.querySelector("iframe.top");if(c=[d],void 0===w.ebook.init_scrolling.prev){var f=document.createElement("a"),p=document.createElement("a");w.ebook.init_scrolling.prev=f,f.textContent="prev",w.ebook.init_scrolling.next=p,p.textContent="next",[f,p].forEach(function(e){e.target="_top",e.style.display="block",e.style.margin="0",e.style.marginTop="0.5rem",e.style.marginBottom="0.5rem",e.style.padding="1rem",e.style.textAlign="center",e.style.fontFamily="monospace"})}e.prev_next(w.ebook.$ebook_spine_real,function(e,n){var i=d.contentDocument,r=w.ebook.init_scrolling.prev,a=w.ebook.init_scrolling.next;null!==e&&(r.href="#"+b("ebook",t,e,"lastpage"),i.body.insertBefore(r,i.body.firstChild)),null!==n&&(a.href="#"+b("ebook",t,n),i.body.appendChild(a)),"function"==typeof $onload&&$onload(),o()})}Array.prototype.forEach.call(c,l)},w.ebook.init=function(e,t,n,i,r,o,s,l){s.contentDocument.onscroll=function(){$(t,n,i,o)},Array.prototype.forEach.call(a.querySelectorAll("iframe.top"),function(e){e.classList.remove("top")}),a.querySelector("iframe.current").classList.add("top"),w.ebook.init_scrolling(e,t,n,i,o,l)};var k=function(e,t,n){var i=n.general.continuous_scrolling,r="horizontal"===n.general.page_scrolling_direction||i===!1,o=r?"scrollLeft":"scrollTop",a=e.contentDocument,s=t.element,l=Math.min(t.rect.left/t.rect.width,t.rect.top/t.rect.height),c=a.evaluate(s,a,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue,u=E(c),d=_(a)[o]+u[r?"left":"top"]-l*u[r?"width":"height"];if(i===!1){var f=a.documentElement.clientWidth;d=Math.floor(d/f)*f}_(a)[o]=d};w.ebook.return_to_reading_position=function(e,t,n,i,r){if(e.general.save_reading_position){var o=e.general.continuous_scrolling,a="horizontal"===e.general.page_scrolling_direction||o===!1,s=a?"scrollLeft":"scrollTop",l=r.contentDocument;if(e.general.save_reading_position!==!1&&void 0!==e.general.reading_position&&(e.general.reading_position.spine===n||void 0===n)){var c=e.general.reading_position.element,u=e.general.reading_position.rect,d=Math.min(u.left/u.width,u.top/u.height);return _(l)[s],{spine:e.general.reading_position.spine,onrendered:function(){var e=l.evaluate(c,l,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue,t=E(e),n=_(l)[s]+t[a?"left":"top"]-d*t[a?"width":"height"];if(o===!1){var i=l.documentElement.clientWidth;n=Math.floor(n/i)*i}_(l)[s]=n}}}}return!1},w.ebook.move_to_hash=function(e,t,n,i){if(w.ebook.$ebook_hash!==t||w.ebook.$ebook_delta!==n){var r=i.general.continuous_scrolling===!1?"scrollLeft":"scrollTop",o=n;if(void 0===o){var a=e.contentDocument.querySelector(t);if(null===a&&(a=e.contentDocument.getElementById(t)),null!==a){var s=a.getClientRects()[0],l=_(e.contentDocument)[r];if(i.general.continuous_scrolling===!1){var c=e.contentDocument.documentElement.clientWidth;o=l+Math.round(s.left/c)*c}else o=l+Math.round(s.top)}}void 0!==o&&(1/0===o&&(o=_(e.contentDocument)[r+"Max"]),_(e.contentDocument)[r]=o),w.ebook.$ebook_hash=t,w.ebook.$ebook_delta=n}},w.ebook.make_link=function(e,t,n){var i=$iframe_el.contentDocument.createElement("a");return w.ebook.link_handler(n)(i),i.textContent=e,i.href=t,i.style.display="block",i.style.lineHeight="2em",i.style.marginTop="2em",i.style.marginBottom="2em",i.style.textAlign="center",i},w.ebook.link_handler=function(e){return function(t){t.addEventListener("click",function(t){if("A"===this.nodeName){t.preventDefault();var n=this.getAttribute("href");w.ebook.$ebook_hash=void 0,window.location.hash=b(a.dataset.prefix,e,n)}})}},w.ebook.render=function(e,t,n){e.contentDocument.open(),e.contentDocument.write(t),e.contentDocument.close(),Array.prototype.forEach.call(e.contentDocument.querySelectorAll("a"),w.ebook.link_handler(n))},w.ebook.$ebook_spine=null;var E=function(e){var t=e;return e instanceof Node?(3===e.nodeType&&(t=document.createRange(),t.selectNode(e)),t.getBoundingClientRect()):{}},S=function(e){var t=({top:e.documentElement.scrollTop,left:e.documentElement.scrollLeft},null),n=null,i=e.body;do{var r=E(i);null===t||"BR"!==t.nodeName&&r.left+r.width>0&&r.top+r.height>0?(t=i,n=r,i=t.firstChild):i=i.nextSibling}while(null!==i);return{element:t,rect:n}},L=function(e){for(var t=[];null!==e;)if(e.id)t.unshift('//*[@id="'+e.id+'"]'),e=null;else{if(null===e.parentNode)t.unshift("");else if(e.nodeType){var n=Array.prototype.reduce.call(e.parentNode.childNodes,function(t){var n=-1;return function(i,r){return r.nodeName===t&&n++,r===e?n:i}}(e.nodeName),null);t.unshift((3===e.nodeType?"text()":e.nodeName)+(n?"["+(n+1)+"]":""))}else t.unshift("text()");e=e.parentNode}return t.join("/")},$=function(){var e,t=null;return function(n,i,r,o){null!==t&&e===n&&window.clearTimeout(t),e!==n&&($.last_position=void 0),e=n,t=window.setTimeout(function(){if(e===n){var t=a.querySelector("iframe.top"),r=S(t.contentDocument),s={spine:i,element:L(r.element),rect:{left:r.rect.left,top:r.rect.top,width:r.rect.width,height:r.rect.height}};$.last_position=s,$.last_settings=o,f.set_settings({"general.reading_position":s},function(){},function(){alert("Can't save reading position.")},n)}},100)}}(),x=function(e,t){var n=p(e),e=n[0],i=n[1],r=n[2],o=n[3];"string"==typeof o&&(o="lastpage"===o?1/0:Number.toInteger(o)),e!==x.$current_ebook_id?f.library().load(e,function(n){x.$current_ebook=n,x.$current_ebook_id=e,t(n,e,i,r,o)}):t(x.$current_ebook,e,i,r,o,x.$current_ebook_metadata)},A=function(e){var t=e.sort(function(e,t){var n=e.creator.map(function(e,t){return t.value}).sort().join(" ")+" "+(e.series?e.series.value:"")+" "+(e.series_index?e.series_index.value:"")+" "+e.title.value,i=t.creator.map(function(e,t){return t.value}).sort().join(" ")+" "+(t.series?t.series.value:"")+" "+(t.series_index?t.series_index.value:"")+" "+t.title.value;return n.localeCompare(i)}).map(function(e){return e});u.value="",render_template("library-item",t,function(e){document.querySelector("#library-list").innerHTML=e,void 0!==A.$focus&&(document.getElementById(A.$focus).focus(),delete A.$focus)})},q=function(e,t,n){var i=new XMLHttpRequest({mozSystem:!0});g("Getting EBook..."),i.open("GET",e),i.overrideMimeType(t||"application/epub+zip"),i.responseType="blob",i.onreadystatechange=function(){4===this.readyState&&(null===this.response?void 0===n?(alert("Could not load EBook"),y()):n(i):v(this.response))},i.send()},U=window.location.protocol+"//"+window.location.hostname+window.location.pathname+"manifest.webapp",C=function(){var e;return function(){return void 0===e?Modernizr._domPrefixes.reduce(function(e,t){return e||window.navigator[t+"Apps"]||window.navigator[t.toLowerCase()+"Apps"]},navigator.apps)||null:e}}(),D=function(){var e;return function(t){if(void 0!==e)return e;if(Modernizr.apps===!0){var n=C().getInstalled();e=null,n.addEventListener("success",function(){e=this.result.filter(function(e){return e.manifestURL===U}),e=0===e.length?null:e[0],t(e)})}}}();Modernizr.addTest("apps",function(){return window.navigator.mozApps}),Modernizr.addTest("system-xhr",function(){return new XMLHttpRequest({mozSystem:!0}).mozSystem});var z=function(e,t,n){e.title(function(i){g("loading "+i+" feeds"),r.forEach(e,{title:function(e,t){e.title(t)},searchengine:function(e,t){e.searchengine(t)},feed:function(e,r){null===t?e.root(function(e){r(e?e.documentElement:null)}):e.get(t,function(t){null!==t?r(t.documentElement):void 0===n?(alert("Can't open this "+i+" feed."),y()):confirm("Can't open this "+i+" feed. Do you want to go to the previous feed?")?z(e,n):y()})}},function(r){render_template("opds-feed",r,function(o){null===r.feed?(alert("Can't open this "+i+" feed."),y()):(m(o),Array.prototype.forEach.call(c.querySelectorAll("button[data-next]"),function(n){n.addEventListener("click",function(n){z(e,n.target.dataset.next,t)})}),Array.prototype.forEach.call(c.querySelectorAll("button[data-ebook-uri]"),function(i){i.addEventListener("click",function(i){i.preventDefault(),q(i.target.dataset.ebookUri,i.target.dataset.type,function(){alert("Could not load EBook"),z(e,t,n)})})}))})})})};f.library().addEventListener("changed",function(e){A(e.$ebooks)}),f.library().addEventListener("added",function(e){window.location=document.querySelector(".target a.back").href,A.$focus=e.$identifier}),o.addEventListener("click",function(e){"BUTTON"===e.target.nodeName&&"delete"===e.target.name&&(e.preventDefault(),f.library().delete(e.target.parentNode.id))}),window.addEventListener("resize",function(){if(void 0!==$.last_position){var e=document.querySelector("iframe.top.current");k(e,$.last_position,$.last_settings)}}),document.querySelector("#import_ebook_input form").addEventListener("submit",function(e){e.preventDefault(),v(this.querySelector("input[type=file]").files[0])}),document.querySelector("#import_ebook_internet form").addEventListener("submit",function(e){e.preventDefault(),q(this.querySelector("input[type=url]").value,this.querySelector("select[name=type]").value)}),document.querySelector("#import_ebook_internet input[type=url]").addEventListener("input",function(){var e=this.value.split("."),t=this.parentNode.querySelector("select[name=type]"),n=t.querySelectorAll("option"),i="";e=e[e.length-1].toLowerCase();for(var r=0;r<n.length;r++)(n[r].value.toLowerCase()===e||n[r].textContent.toLowerCase()===e)&&(i=n[r].value);t.value=i}),Array.prototype.forEach.call(document.querySelectorAll("#import_ebook_sample a"),function(e){e.addEventListener("click",function(e){e.preventDefault(),q(this.getAttribute("href"),"application/epub+zip")})}),s.querySelector(".content").addEventListener("click",function(e){"A"===e.target.nodeName&&(e.preventDefault(),w.ebook.$ebook_hash=void 0,window.location.hash=b(a.dataset.prefix,s.dataset.ebook_id,e.target.getAttribute("href")))}),document.querySelector("#fullscreen").addEventListener("click",function(e){e.preventDefault();var t=a.querySelector(".content");t.requestFullScreen?t.requestFullScreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullScreen&&t.webkitRequestFullScreen()}),window.addEventListener("hashchange",w),f.addEventListener("initied",w),i.register("www.smashwords.com/atom"),i.register("http://manybooks.net/opds/"),i.register("http://m.gutenberg.org"),i.register("http://www.feedbooks.com"),i.register("http://cops-demo.slucas.fr/"),i.register(location.origin),f.init()});var render_template=function(e,t,n){var i=new XMLHttpRequest;i.open("GET","templates/"+e+".html"),i.onreadystatechange=function(){if(4===this.readyState){var i={};i[e]=this.response,jsviews.templates(i),n(jsviews.render[e](t))}},i.send()};define("index.prod",function(){});